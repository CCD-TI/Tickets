<p-toast></p-toast>
<div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 p-4 sm:p-6 lg:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Mobile Header -->
    <div class="md:hidden flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <button
          (click)="mobileMenuOpen = !mobileMenuOpen"
          class="p-2 rounded-full hover:bg-gray-700 transition-colors text-gray-400 hover:text-white"
        >
          <i class="pi {{ mobileMenuOpen ? 'pi-times' : 'pi-bars' }}"></i>
        </button>
        <div class="p-2 bg-blue-600/20 rounded-lg">
          <img class="w-8 h-8 object-contain" src="/faviconCCD.ico" alt="Logo" />
        </div>
      </div>
      <button
        (click)="navigateToCreateTicket()"
        class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors"
      >
        <i class="pi pi-plus"></i>
        <span>Nuevo</span>
      </button>
    </div>

    <!-- Header Section -->
    <div
      class="flex flex-col md:flex-row items-center justify-between mb-6 md:mb-8 gap-4"
      [ngClass]="{'block': mobileMenuOpen, 'hidden': !mobileMenuOpen, 'md:flex': true}"
    >
      <div class="flex items-center gap-4">
        <div class="p-3 bg-blue-600/20 rounded-lg hidden md:block">
          <img class="w-12 h-12 object-contain" src="/faviconCCD.ico" alt="Logo" />
        </div>
        <div class="text-center md:text-left">
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white tracking-tight">Mis Tickets</h1>
          <p class="text-sm sm:text-base text-gray-400">Portal de Usuario - Gestión de Solicitudes</p>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
        <button
          (click)="navigateToCreateTicket()"
          class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg h-12 transition-colors"
        >
          <i class="pi pi-plus"></i>
          <span>Nuevo Ticket</span>
        </button>
        <button
          (click)="logout()"
          class="flex items-center justify-center gap-2 border border-gray-500 hover:border-gray-400 text-white font-semibold py-2 px-6 rounded-lg h-12 transition-colors"
        >
          <i class="pi pi-sign-out"></i>
          <span>Cerrar Sesión</span>
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
      <div 
        *ngFor="let stat of [
          { icon: 'pi pi-ticket', label: 'Total', value: stats().total, color: 'blue'},
          { icon: 'pi pi-clock', label: 'Pendientes', value: stats().pending, color: 'yellow'},
          { icon: 'pi pi-exclamation-circle', label: 'En Progreso', value: stats().inProgress, color: 'blue'},
          { icon: 'pi pi-check-circle', label: 'Resueltos', value: stats().resolved, color: 'green'}
        ]" 
        class="bg-gray-800 border border-gray-700 hover:border-blue-500/50 shadow-md hover:shadow-lg transition-all rounded-lg cursor-pointer p-4"
        (click)="filterByStat(stat)"
      >
        <div class="flex items-center gap-4">
          <div [class]="'p-3 rounded-lg bg-' + stat.color + '-600/20'">
            <i [class]="stat.icon + ' text-' + stat.color + '-400 text-xl'"></i>
          </div>
          <div>
            <p class="text-sm text-gray-300">{{ stat.label }}</p>
            <p class="text-xl font-bold text-white">{{ stat.value }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search Bar -->
    <div class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl mb-8 p-4 sm:p-6">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <!-- Search -->
        <div>
          <label for="search" class="block text-sm font-medium text-gray-300 mb-1">Buscar tickets</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <i class="pi pi-search text-gray-500"></i>
            </div>
            <input
              type="text"
              id="search"
              [(ngModel)]="searchTerm"
              placeholder="Buscar por ID o asunto..."
              class="w-full h-12 pl-10 bg-gray-700 border border-gray-600 text-white rounded-lg focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
        </div>
        
        <!-- Priority Filter -->
        <div>
          <label for="priority-filter" class="block text-sm font-medium text-gray-300 mb-1">Prioridad</label>
          <select
            id="priority-filter"
            [(ngModel)]="selectedPriority"
            class="w-full h-12 px-4 bg-gray-700 border border-gray-600 text-white rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-blue-500"
          >
            <option value="">Todas las prioridades</option>
            <option *ngFor="let option of priorityOptions" [value]="option.value">{{option.label}}</option>
          </select>
        </div>
        
        <!-- Status Filter -->
        <div>
          <label for="status-filter" class="block text-sm font-medium text-gray-300 mb-1">Estado</label>
          <select
            id="status-filter"
            [(ngModel)]="selectedStatus"
            class="w-full h-12 px-4 bg-gray-700 border border-gray-600 text-white rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-blue-500"
          >
            <option value="">Todos los estados</option>
            <option *ngFor="let option of statusOptions" [value]="option.value">{{option.label}}</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Tickets List -->
    <div class="space-y-4">
      @for(ticket of filteredTickets(); track $index) {
      <app-ticket-card
        [ticket]="ticket"
        [statusBadge]="getStatusBadge(ticket.status)"
        [priorityBadge]="getPriorityBadge(ticket.priority)"
        (cardClicked)="openTicketDetail(ticket)"
      ></app-ticket-card>
      }
      @if(filteredTickets().length === 0) {
      <div class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-8 sm:p-12 text-center">
        <i class="pi pi-inbox text-4xl text-gray-600 mx-auto mb-4"></i>
        <h3 class="text-xl font-semibold text-white mb-2">
          {{ searchTerm || selectedPriority || selectedStatus ? 'No se encontraron tickets' : 'No tienes tickets creados' }}
        </h3>
        <p class="text-gray-400 mb-6">
          {{ searchTerm || selectedPriority || selectedStatus ? 
            'No hay tickets que coincidan con los filtros aplicados.' : 
            'Crea tu primer ticket para comenzar.' }}
        </p>
        <button
          (click)="navigateToCreateTicket()"
          class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg mx-auto transition-colors"
        >
          <i class="pi pi-plus"></i>
          <span>Crear Ticket</span>
        </button>
      </div>
      }
    </div>

    <!-- Ticket Detail Modal -->
    <div *ngIf="selectedTicket" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" (click)="modalActive = false">
      <div 
        class="bg-gray-800 border border-gray-700 rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()"
      >
        <!-- Modal Header -->
        <div class="border-b border-gray-700 p-4 sm:p-6 flex justify-between items-center">
          <h3 class="text-xl font-bold text-white">
            Detalle del Ticket - #{{ selectedTicket.id.substring(0, 8) }}
          </h3>
          <button 
            (click)="modalActive = false"
            class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gray-700"
          >
            <i class="pi pi-times"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="space-y-6 p-4 sm:p-6">
          <!-- Status and Priority -->
          <div class="flex flex-wrap gap-4 mb-4">
            <div>
              <span class="text-sm text-gray-400">Estado:</span>
              <span 
                [class]="getStatusBadge(selectedTicket.status).class + ' ml-2 px-3 py-1 rounded-full text-xs font-medium'"
              >
                {{ getStatusBadge(selectedTicket.status).label }}
              </span>
            </div>
            <div>
              <span class="text-sm text-gray-400">Prioridad:</span>
              <span 
                [class]="getPriorityBadge(selectedTicket.priority).class + ' ml-2 px-3 py-1 rounded-full text-xs font-medium'"
              >
                {{ getPriorityBadge(selectedTicket.priority).label }}
              </span>
            </div>
          </div>

          <!-- Subject -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Asunto</label>
            <p class="text-lg text-white font-semibold">{{ selectedTicket.asunto || 'Sin asunto' }}</p>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Descripción</label>
            <p class="text-gray-400 whitespace-pre-line">{{ selectedTicket.descripcion || 'Sin descripción' }}</p>
          </div>

          <!-- Metadata Grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Área</label>
              <p class="text-gray-400">{{ selectedTicket.area_destino.nombre || 'N/A' }}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Proyecto</label>
              <p class="text-gray-400">{{ selectedTicket.proyecto_id?.nombre || 'N/A' }}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Tipo de Problema</label>
              <p class="text-gray-400">{{ selectedTicket.tipo_problema_id.nombre || 'N/A' }}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Fecha de Creación</label>
              <p class="text-gray-400">{{ selectedTicket.created_at | date: 'medium' }}</p>
            </div>
          </div>

          <!-- Responses Section -->
          @if(selectedTicket.ticket_responses.length > 0) {
            <div class="pt-4 border-t border-gray-700">
              <label class="block text-sm font-medium text-gray-300 mb-3">Respuestas</label>
              <div class="space-y-4">
                @for(response of selectedTicket.ticket_responses; track $index) {
                  <div class="bg-gray-700/50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                      <p class="text-sm font-medium text-white">
                        {{ response.user_id === user?.user_id ? 'Tú' : 'Soporte' }}
                      </p>
                      <p class="text-xs text-gray-400">
                        {{ response.created_at | date: 'medium' }}
                      </p>
                    </div>
                    <p class="text-gray-300 whitespace-pre-line">{{ response.mensaje }}</p>
                  </div>
                }
              </div>
            </div>
          }
          @else {
            <div class="text-center py-6 text-gray-500">
              No hay respuestas para este ticket.
            </div>
          }

          <!-- Actions -->
          <div class="flex justify-end pt-4 border-t border-gray-700">
            <button
              (click)="selectedTicket = null; modalActive = false"
              class="flex items-center justify-center gap-2 border border-gray-500 hover:border-gray-400 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
            >
              <i class="pi pi-times"></i>
              <span>Cerrar</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>